---
import Layout from "../layouts/Layout.astro";

// Données dynamiques via l'API PocketBase
let data = {};
try {
    const res = await fetch("/api/personnalisation");
    data = await res.json();
} catch (e) {
    data = { materiauxMonture: [], materiauxVerres: [] };
}

// Remplace ces palettes par des collections si besoin
const couleursMonture = [
    "#222d3a",
    "#a78b61",
    "#ffbe76",
    "#118ab2",
    "#d95d39",
    "#6e8898",
    "#f7b267",
];
const couleursVerre = [
    "#7fa1e7",
    "#fee440",
    "#37bfbb",
    "#fbbf24",
    "#dd86a0",
    "#94849b",
    "#e5e7eb",
    "#8a76a1",
];
const couleursBranche = [
    "#222d3a",
    "#a78b61",
    "#ffbe76",
    "#118ab2",
    "#d95d39",
    "#6e8898",
    "#f7b267",
];
const tailles = ["S", "M", "L"];
---

<pre>{JSON.stringify(data, null, 2)}</pre>

<Layout title="Personnalisation lunettes">
    <h1 style="font-size:2em;font-weight:800;margin-bottom:1.2em;">
        Personnalisez vos lunettes
    </h1>

    <!-- SVG lunettes, ids ajoutés ! -->
    <div class="preview-svg" style="margin-bottom:2em;">
        <svg
            id="svg-lunettes"
            viewBox="0 0 595.28 350"
            width="390"
            height="140"
        >
            <g>
                <g id="branches">
                    <path
                        id="branch1"
                        fill="#706f6f"
                        d="M108.83,155.14s49.35-5.57,54.93-8.76,11.14-7.96,19.5-9.55,64.48-11.14,64.48-11.14c0,0,7.16-1.99,17.51,5.57s33.04,31.84,39.4,31.05c6.37-.8,9.55-9.55,7.56-13.53s-40.67-32.75-47.36-34.63c-9.53-2.68-21.89-2.39-37.02,0-15.12,2.39-116.22,23.34-116.22,23.34,0,0-13.13,6.12-2.79,17.66Z"
                    ></path>
                    <path
                        id="branch2"
                        fill="#a78b61"
                        d="M308.24,150.76s-.31,6.15-3.98,5.57c-4.97-.78-35.82-33.83-46.17-32.24,0,0,8.53,2.71,18.46,11.64,6.51,5.86,34.42,37.85,31.69,15.03Z"
                    ></path>
                    <path
                        id="branch3"
                        fill="#a78b61"
                        d="M374.79,179.65l90.54-29.78s22.13-5.63,25.35-4.02,17.71,30.58,17.71,33.8-2.42,14.01-5.63,14.89c-2.33.64-5.33.11-6.84-4.21-1.41-4.02-6.84-31.73-12.47-31.47s-50.7,15.95-50.7,15.95c0,0-13.28,6.44-18.91,11.27s-32.19,11.27-32.19,11.27c0,0-9.66-7.65-6.84-17.71Z"
                    ></path>
                    <path
                        id="branch4"
                        fill="#706f6f"
                        d="M381.34,180.1s102.27-35.19,107.85-31.99c0,0-18.2,2.49-41.76,11.88s-66.09,22.03-66.09,22.03v-1.92Z"
                    ></path>
                    <path
                        id="branch5"
                        fill="#706f6f"
                        d="M485.36,158.06s3.26,0,4.98,3.45,9.77,24.71,9.77,24.71c0,0,.77,4.98,5.17-2.68,0,0-3.07,9.56-5.36,6.79s-9.77-26.33-9.77-26.33c0,0-2.87-6.74-4.79-5.94Z"
                    ></path>
                </g>
                <g id="monture">
                    <path
                        id="monture-main"
                        fill="#222d3a"
                        d="M385.31,180.81c-.24-3.41-9.57-5.22-12.71-6.4-3.14-1.18-15.7,1.96-15.7,1.96-12.17-3.14-54.55-9.03-78.88-9.03s-32.57,11.38-35.32,10.99c-2.75-.39-17.27-.78-23.55-1.96-6.28-1.18-5.1-14.13-39.25-26.48-34.14-12.35-68.29-12.42-68.29-12.42-13.35,4.66-6.76,18.49-6.76,18.49l2.05,6.35c4.32,2.03,3.14,10.52,4.71,23.08s7.46,28.65,14.13,38.46c6.67,9.81,31.79,20.8,44.35,21.19s23.55-1.96,31.79-15.31c8.24-13.34,16.88-36.89,16.88-36.89l10.2,1.57s2.91.31,5.35,3.09,4.43,8.03,7.6,17.31c7.56,22.1,25.12,39.25,25.12,39.25,0,0,5.6,7.43,33.44,12.66,23.08,4.34,42.7-2.46,42.7-2.46,17.72-7.17,21.63-44.96,21.63-44.96,0,0,1.83-13.3,7.81-16.65,7.37-4.14,8.27-4.44,12.71-5.32,3.61-.71.24-13.13,0-16.54Z"
                    ></path>
                </g>
                <g id="verres">
                    <path
                        id="verreG"
                        fill="#7fa1e7"
                        opacity="0.65"
                        d="M116.32,162.87c-.88,6.05.4,37.41,11.44,55.31s37.04,21.35,41.37,21.31,18.51,1.02,24.47-9.27c4.97-8.59,13.17-43.48,9.12-53.05-6.26-14.82-40.4-24.02-40.4-24.02,0,0-26.85-5.46-33.82-4.46,0,0-9.97-.96-12.17,14.17Z"
                    ></path>
                    <path
                        id="verreD"
                        fill="#7fa1e7"
                        opacity="0.65"
                        d="M247.32,192.54s-1.09-9.55,19.57-16.69c11.76-4.06,60.46,3.23,60.46,3.23,0,0,19.09,4.06,21.71,8.28,2.62,4.22,9.46,17.24,8.29,37.97-1.14,20.21-7.31,26.8-12.61,30.31,0,0-7.1,4.93-21.34,5.93-26.65,1.88-37.01-1.14-46.19-7.73-29.88-21.46-29.88-61.3-29.88-61.3Z"
                    ></path>
                </g>
            </g>
        </svg>
    </div>

    <!-- Configurateur -->
    <form id="form-config" method="POST" style="margin-bottom:1em;">
        <!-- Matériau monture -->
        <div>
            <label style="font-weight:600;">Matériau de la monture :</label>
            <div style="display:flex;flex-wrap:wrap;gap:1em;margin-top:0.7em;">
                {
                    data.materiauxMonture.map((mat) => (
                        <button
                            class="mat-btn"
                            type="button"
                            data-id={mat.id}
                            data-nom={mat.nom_materiaux}
                            data-prix={mat.prix_materiaux}
                        >
                            {mat.nom_materiaux}{" "}
                            <span style="font-size:.95em;color:#2563eb;">
                                {mat.prix_materiaux}€
                            </span>
                        </button>
                    ))
                }
            </div>
        </div>
        <!-- Couleur monture -->
        <div style="margin-top:1em;">
            <label>Couleur de la monture :</label>
            <div style="display:flex;flex-wrap:wrap;gap:0.8em;">
                {
                    couleursMonture.map((col) => (
                        <button
                            type="button"
                            class="color-btn"
                            style={`background:${col}`}
                            data-col={col}
                        />
                    ))
                }
            </div>
        </div>
        <!-- Taille -->
        <div style="margin-top:1em;">
            <label>Taille monture :</label>
            <div style="display:flex;gap:0.7em;">
                {
                    tailles.map((t) => (
                        <button
                            type="button"
                            class="taille-btn"
                            data-taille={t}
                        >
                            {t}
                        </button>
                    ))
                }
            </div>
        </div>
        <!-- Type de verres -->
        <div style="margin-top:1em;">
            <label style="font-weight:600;">Type de verres :</label>
            <div style="display:flex;flex-wrap:wrap;gap:1em;margin-top:0.7em;">
                {
                    data.materiauxVerres.map((verre) => (
                        <button
                            class="verre-btn"
                            type="button"
                            data-id={verre.id}
                            data-nom={verre.nom_verres}
                            data-prix={verre.prix_verres}
                        >
                            {verre.nom_verres}{" "}
                            <span style="font-size:.95em;color:#2563eb;">
                                {verre.prix_verres}€
                            </span>
                        </button>
                    ))
                }
            </div>
        </div>
        <!-- Couleur verres -->
        <div style="margin-top:1em;">
            <label>Couleur des verres :</label>
            <div style="display:flex;flex-wrap:wrap;gap:0.8em;">
                {
                    couleursVerre.map((col) => (
                        <button
                            type="button"
                            class="color-verre-btn"
                            style={`background:${col}`}
                            data-col={col}
                        />
                    ))
                }
            </div>
        </div>
        <!-- Couleur branches -->
        <div style="margin-top:1em;">
            <label>Couleur des branches :</label>
            <div style="display:flex;flex-wrap:wrap;gap:0.8em;">
                {
                    couleursBranche.map((col) => (
                        <button
                            type="button"
                            class="color-branche-btn"
                            style={`background:${col}`}
                            data-col={col}
                        />
                    ))
                }
            </div>
        </div>
        <!-- Nom du modèle -->
        <div style="margin-top:1em;">
            <label for="nom-modele">Nom du modèle :</label>
            <input
                id="nom-modele"
                name="nom_modele"
                class="input-box"
                placeholder="MaTulwa"
                required
            />
        </div>
        <!-- Prix -->
        <div style="margin:1em 0;">
            <span
                id="prix-total"
                style="font-size:1.05em;color:#2563eb;font-weight:700;"
                >Total : 0€</span
            >
        </div>
        <!-- Sauvegarder -->
        <button type="submit" class="save-btn"
            >Enregistrer ma configuration</button
        >
    </form>
    <div id="recapitulatif"></div>

    <script>
        const selection = { prix_monture: 0, prix_verre: 0 };
        // Matériau monture
        document.querySelectorAll(".mat-btn").forEach(
            (btn) =>
                (btn.onclick = () => {
                    document
                        .querySelectorAll(".mat-btn")
                        .forEach((b) => b.classList.remove("selected"));
                    btn.classList.add("selected");
                    selection.materiau = {
                        id: btn.dataset.id,
                        nom: btn.dataset.nom,
                    };
                    selection.prix_monture = parseFloat(btn.dataset.prix) || 0;
                    updateRecap();
                    updatePrix();
                }),
        );
        // Couleur monture
        document.querySelectorAll(".color-btn").forEach(
            (btn) =>
                (btn.onclick = () => {
                    document
                        .querySelectorAll(".color-btn")
                        .forEach((b) => b.classList.remove("selected"));
                    btn.classList.add("selected");
                    selection.couleur_monture = btn.dataset.col;
                    document
                        .querySelector("#monture path")
                        .setAttribute("fill", selection.couleur_monture);
                    updateRecap();
                }),
        );
        // Taille
        document.querySelectorAll(".taille-btn").forEach(
            (btn) =>
                (btn.onclick = () => {
                    document
                        .querySelectorAll(".taille-btn")
                        .forEach((b) => b.classList.remove("selected"));
                    btn.classList.add("selected");
                    selection.taille = btn.dataset.taille;
                    updateRecap();
                }),
        );
        // Type verres
        document.querySelectorAll(".verre-btn").forEach(
            (btn) =>
                (btn.onclick = () => {
                    document
                        .querySelectorAll(".verre-btn")
                        .forEach((b) => b.classList.remove("selected"));
                    btn.classList.add("selected");
                    selection.verre = {
                        id: btn.dataset.id,
                        nom: btn.dataset.nom,
                    };
                    selection.prix_verre = parseFloat(btn.dataset.prix) || 0;
                    updateRecap();
                    updatePrix();
                }),
        );
        // Couleur verres
        document.querySelectorAll(".color-verre-btn").forEach(
            (btn) =>
                (btn.onclick = () => {
                    document
                        .querySelectorAll(".color-verre-btn")
                        .forEach((b) => b.classList.remove("selected"));
                    btn.classList.add("selected");
                    selection.couleur_verre = btn.dataset.col;
                    document.querySelectorAll("#verres path").forEach((el) => {
                        el.setAttribute("fill", selection.couleur_verre);
                        el.setAttribute("opacity", 0.65);
                    });
                    updateRecap();
                }),
        );
        // Couleur branches
        document.querySelectorAll(".color-branche-btn").forEach(
            (btn) =>
                (btn.onclick = () => {
                    document
                        .querySelectorAll(".color-branche-btn")
                        .forEach((b) => b.classList.remove("selected"));
                    btn.classList.add("selected");
                    selection.couleur_branche = btn.dataset.col;
                    document
                        .querySelectorAll("#branches path")
                        .forEach((el) =>
                            el.setAttribute("fill", selection.couleur_branche),
                        );
                    updateRecap();
                }),
        );

        function updatePrix() {
            document.getElementById("prix-total").textContent =
                "Total : " +
                (
                    (selection.prix_monture || 0) + (selection.prix_verre || 0)
                ).toFixed(2) +
                "€";
        }
        function updateRecap() {
            let recap = `<h3 style="font-size:1.05em;margin-top:1em;">Résumé :</h3><ul style="padding-left:1em;font-size:.97em;">`;
            if (selection.materiau)
                recap += `<li>Matériau : ${selection.materiau.nom} (${selection.prix_monture}€)</li>`;
            if (selection.couleur_monture)
                recap += `<li>Couleur monture : <span style="display:inline-block;width:16px;height:16px;background:${selection.couleur_monture};border-radius:3px;"></span></li>`;
            if (selection.taille)
                recap += `<li>Taille : ${selection.taille}</li>`;
            if (selection.verre)
                recap += `<li>Type verre : ${selection.verre.nom} (${selection.prix_verre}€)</li>`;
            if (selection.couleur_verre)
                recap += `<li>Couleur verre : <span style="display:inline-block;width:16px;height:16px;background:${selection.couleur_verre};border-radius:3px;"></span></li>`;
            if (selection.couleur_branche)
                recap += `<li>Couleur branche : <span style="display:inline-block;width:16px;height:16px;background:${selection.couleur_branche};border-radius:3px;"></span></li>`;
            recap += `</ul>`;
            document.getElementById("recapitulatif").innerHTML = recap;
        }
        document.getElementById("form-config").onsubmit = async (evt) => {
            evt.preventDefault();
            const res = await fetch("/api/creer", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    ...selection,
                    nom_modele: document.getElementById("nom-modele").value,
                }),
            });
            if (res.ok) alert("Configuration sauvegardée !");
            else alert("Erreur lors de la sauvegarde !");
        };
    </script>
    <style>
        .color-btn,
        .color-verre-btn,
        .color-branche-btn {
            width: 32px;
            height: 32px;
            border-radius: 7px;
            border: 2px solid #eee;
            cursor: pointer;
            margin: 4px;
        }
        .selected {
            border: 2.5px solid #2563eb !important;
        }
        .input-box {
            padding: 0.5em;
            border-radius: 6px;
            border: 1.1px solid #d8e0ed;
            background: #232537;
            font-size: 1em;
            color: #fff;
        }
        .save-btn {
            margin-top: 20px;
            padding: 0.7em 2em;
            border-radius: 6px;
            background: linear-gradient(90deg, #2563eb, #3b82f6);
            color: #fff;
            font-weight: 700;
            cursor: pointer;
        }
        .mat-btn,
        .verre-btn,
        .taille-btn {
            margin: 2px 12px 2px 0;
            padding: 0.5em 1.2em;
            border-radius: 7px;
            border: 1.4px solid #ccc;
            background: #fff;
            cursor: pointer;
        }
        .mat-btn.selected,
        .verre-btn.selected,
        .taille-btn.selected {
            border: 2.2px solid #2563eb;
            background: #eaf3fe;
            color: #013;
        }
        form > div {
            margin-top: 1.2em;
        }
    </style>
</Layout>
