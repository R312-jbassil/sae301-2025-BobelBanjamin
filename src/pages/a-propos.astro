---
import PocketBase from "pocketbase";

let user = null;
if (Astro.cookies?.get("pb_auth")) {
    try {
        const pb = new PocketBase(
            import.meta.env.PUBLIC_POCKETBASE_URL || "http://127.0.0.1:8090",
        );
        pb.authStore.loadFromCookie(Astro.cookies.get("pb_auth").value);
        user = pb.authStore.model;
    } catch {}
}
---

<header class="header-wrapper">
    <div class="header-container">
        <!-- Logo à gauche -->
        <a href="/" class="header-logo">
            <div class="logo-circle"></div>
        </a>
        <!-- Navigation centrale -->
        <nav class="header-nav">
            <a href="/collection" class="nav-link">Collection</a>
            <a href="/personnalisation" class="nav-link">Personnalisation</a>
            <a href="/a-propos" class="nav-link">A propos</a>
        </nav>
        <!-- Profil/avatar -->
        <div class="header-auth">
            {
                user ? (
                    <div class="dropdown">
                        <button
                            class="avatar-btn"
                            id="profile-toggle"
                            aria-label="Profil"
                            type="button"
                        >
                            <svg viewBox="0 0 40 40" width="40" height="40">
                                <circle
                                    cx="20"
                                    cy="20"
                                    r="19"
                                    fill="#2563eb"
                                    stroke="#1e40af"
                                    stroke-width="2"
                                />
                                <circle cx="20" cy="17" r="7" fill="#fff" />
                                <ellipse
                                    cx="20"
                                    cy="30"
                                    rx="11"
                                    ry="5.5"
                                    fill="#fff"
                                />
                            </svg>
                        </button>
                        <div class="dropdown-menu" id="profile-menu">
                            <div class="dropdown-name">
                                {user.name ?? user.email}
                            </div>
                            <a class="dropdown-logout" href="/logout">
                                Déconnexion
                            </a>
                        </div>
                    </div>
                ) : (
                    <a class="nav-link nav-login" href="/login">
                        Se connecter
                    </a>
                )
            }
        </div>
    </div>
    <script is:inline>
        window.addEventListener("DOMContentLoaded", function () {
            var toggle = document.getElementById("profile-toggle");
            var menu = document.getElementById("profile-menu");
            if (toggle && menu) {
                toggle.onclick = function (e) {
                    e.stopPropagation();
                    menu.classList.toggle("show");
                };
                document.addEventListener("click", function (e) {
                    if (!menu.contains(e.target) && e.target !== toggle) {
                        menu.classList.remove("show");
                    }
                });
            }
        });
    </script>
</header>

<style>
    .header-wrapper {
        width: 100vw;
        background: white;
        box-shadow: 0 2px 12px #1e40af0a;
    }
    .header-container {
        max-width: 1100px;
        margin: 0 auto;
        width: 100%;
        min-height: 68px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1.25rem 3rem;
        gap: 2rem;
        position: relative;
    }
    .header-logo {
        display: flex;
        align-items: center;
        flex-shrink: 0;
        margin-right: 1.8rem;
    }
    .logo-circle {
        width: 1.75rem;
        height: 1.75rem;
        border-radius: 50%;
        border: 3px solid #1e40af;
        background: linear-gradient(135deg, #1e40af 0%, #2563eb 100%);
    }
    .header-nav {
        flex: 1;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 3rem;
        min-width: 0;
    }
    .nav-link {
        font-family: "Plus Jakarta Sans", sans-serif;
        font-size: 0.91rem;
        font-weight: 600;
        letter-spacing: 0.11em;
        color: #1a1a1a;
        text-decoration: none;
        text-transform: uppercase;
        transition: color 0.3s;
        border-radius: 6px;
        padding: 0.25em 0.2em;
    }
    .nav-link:hover {
        color: #1e40af;
        background: #c9dbfd1c;
    }
    .nav-login {
        background: #232537;
        color: #fff;
        border-radius: 6px;
        padding: 0.4em 1.2em;
    }
    .header-auth {
        display: flex;
        align-items: center;
        min-width: 0;
        gap: 0.5rem;
        margin-left: 1.7rem;
    }
    .dropdown {
        position: relative;
        display: inline-block;
    }
    .avatar-btn {
        background: none;
        border: none;
        padding: 0;
        cursor: pointer;
        outline: none;
    }
    .avatar-btn:focus-visible {
        outline: 2px solid #2563eb;
    }
    .dropdown-menu {
        position: absolute;
        top: 110%;
        right: 0;
        min-width: 165px;
        background: #fff;
        border: 1.5px solid #ccd0f6;
        box-shadow: 0 4px 18px #3640b926;
        border-radius: 9px;
        opacity: 0;
        pointer-events: none;
        transform: translateY(8px) scale(0.97);
        transition: all 0.16s cubic-bezier(0.3, 0.68, 0.46, 1.11);
        z-index: 500;
        padding: 0.85em 0.7em 0.7em 0.97em;
        display: flex;
        flex-direction: column;
        gap: 1em;
    }
    .dropdown-menu.show {
        opacity: 1;
        pointer-events: auto;
        transform: translateY(0) scale(1);
    }
    .dropdown-name {
        font-weight: 700;
        color: #232537;
        margin-bottom: 0.25em;
        font-size: 1rem;
        word-break: break-word;
    }
    .dropdown-logout {
        color: #d32f2f;
        font-weight: 700;
        background: none;
        border: none;
        padding: 0.35em 0;
        font-size: 0.97rem;
        cursor: pointer;
        text-decoration: none;
        border-radius: 4px;
        letter-spacing: 0.05em;
        transition: background 0.17s;
    }
    .dropdown-logout:hover {
        background: #ffe0e0;
    }
    @media (max-width: 900px) {
        .header-container {
            padding: 1rem 1.2rem;
            gap: 0.7rem;
        }
        .header-nav {
            gap: 1.2rem;
        }
        .header-logo {
            margin-right: 0.9rem;
        }
    }
    @media (max-width: 700px) {
        .header-container {
            flex-direction: column;
            align-items: center;
            gap: 0.4rem;
            min-height: 54px;
        }
        .header-nav {
            gap: 0.83rem;
            margin: 0.3rem 0;
        }
        .header-logo {
            margin-right: 0;
            margin-bottom: 0.6rem;
        }
        .header-auth {
            margin: 0;
        }
    }
</style>
