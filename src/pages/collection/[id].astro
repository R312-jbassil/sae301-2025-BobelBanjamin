---
import Layout from "../../layouts/Layout.astro";
import pb from "../../lib/pb.js";
import PocketBase from "pocketbase";

// Vérifier si l'utilisateur est connecté
let isAuthenticated = false;
let userId = null;
const authCookie = Astro.cookies.get("pb_auth");

if (authCookie && authCookie.value) {
    try {
        const pbAuth = new PocketBase(
            import.meta.env.PUBLIC_POCKETBASE_URL || "http://127.0.0.1:8090",
        );
        pbAuth.authStore.loadFromCookie(authCookie.value);
        isAuthenticated = pbAuth.authStore.isValid && !!pbAuth.authStore.model;
        userId = pbAuth.authStore.model?.id;
    } catch (e) {
        console.error("Erreur vérification auth:", e);
        isAuthenticated = false;
    }
}

// Rediriger vers login si non connecté
if (!isAuthenticated) {
    return Astro.redirect("/login");
}

// Récupérer l'ID de la lunette depuis l'URL
const { id } = Astro.params;

// Charger les données de la lunette
let lunette = null;
let isOwner = false;

try {
    // Récupérer la lunette avec ses relations
    lunette = await pb.collection("lunette").getOne(id, {
        expand: "materiaux_lunettes,id_verres",
    });

    // Vérifier si l'utilisateur est le créateur
    const relation = await pb
        .collection("creer")
        .getFirstListItem(`id_lunettes="${id}" && id_utilisateur="${userId}"`);
    isOwner = !!relation;

    console.log(
        "Lunette chargée:",
        lunette.nom_modele,
        "- Propriétaire:",
        isOwner,
    );
} catch (e) {
    console.error("Erreur chargement lunette:", e);
    // Rediriger vers la collection si la lunette n'existe pas
    return Astro.redirect("/collection");
}

// Parser le code_svg si c'est un JSON
let svgColors = null;
if (lunette.code_svg) {
    try {
        svgColors = JSON.parse(lunette.code_svg);
    } catch (e) {
        console.log("code_svg n'est pas du JSON");
    }
}
---

<Layout title={`Lunette - ${lunette.nom_modele}`}>
    <main class="lunette-detail-container">
        <div class="back-link">
            <a href="/collection">← Retour à ma collection</a>
        </div>

        <div class="lunette-detail-grid">
            <!-- Prévisualisation SVG grande taille -->
            <div class="lunette-preview-large">
                <div class="preview-card">
                    <svg viewBox="0 0 595.28 350" width="100%" height="auto">
                        <g>
                            <g id="branches">
                                <path
                                    fill={lunette.couleur_branche}
                                    d="M108.83,155.14s49.35-5.57,54.93-8.76,11.14-7.96,19.5-9.55,64.48-11.14,64.48-11.14c0,0,7.16-1.99,17.51,5.57s33.04,31.84,39.4,31.05c6.37-.8,9.55-9.55,7.56-13.53s-40.67-32.75-47.36-34.63c-9.53-2.68-21.89-2.39-37.02,0-15.12,2.39-116.22,23.34-116.22,23.34,0,0-13.13,6.12-2.79,17.66Z"
                                ></path>
                                <path
                                    fill={lunette.couleur_branche}
                                    d="M308.24,150.76s-.31,6.15-3.98,5.57c-4.97-.78-35.82-33.83-46.17-32.24,0,0,8.53,2.71,18.46,11.64,6.51,5.86,34.42,37.85,31.69,15.03Z"
                                ></path>
                                <path
                                    fill={lunette.couleur_branche}
                                    d="M374.79,179.65l90.54-29.78s22.13-5.63,25.35-4.02,17.71,30.58,17.71,33.8-2.42,14.01-5.63,14.89c-2.33.64-5.33.11-6.84-4.21-1.41-4.02-6.84-31.73-12.47-31.47s-50.7,15.95-50.7,15.95c0,0-13.28,6.44-18.91,11.27s-32.19,11.27-32.19,11.27c0,0-9.66-7.65-6.84-17.71Z"
                                ></path>
                                <path
                                    fill={lunette.couleur_branche}
                                    d="M381.34,180.1s102.27-35.19,107.85-31.99c0,0-18.2,2.49-41.76,11.88s-66.09,22.03-66.09,22.03v-1.92Z"
                                ></path>
                                <path
                                    fill={lunette.couleur_branche}
                                    d="M485.36,158.06s3.26,0,4.98,3.45,9.77,24.71,9.77,24.71c0,0,.77,4.98,5.17-2.68,0,0-3.07,9.56-5.36,6.79s-9.77-26.33-9.77-26.33c0,0-2.87-6.74-4.79-5.94Z"
                                ></path>
                            </g>
                            <g id="monture">
                                <path
                                    fill={lunette.couleur_monture}
                                    d="M385.31,180.81c-.24-3.41-9.57-5.22-12.71-6.4-3.14-1.18-15.7,1.96-15.7,1.96-12.17-3.14-54.55-9.03-78.88-9.03s-32.57,11.38-35.32,10.99c-2.75-.39-17.27-.78-23.55-1.96-6.28-1.18-5.1-14.13-39.25-26.48-34.14-12.35-68.29-12.42-68.29-12.42-13.35,4.66-6.76,18.49-6.76,18.49l2.05,6.35c4.32,2.03,3.14,10.52,4.71,23.08s7.46,28.65,14.13,38.46c6.67,9.81,31.79,20.8,44.35,21.19s23.55-1.96,31.79-15.31c8.24-13.34,16.88-36.89,16.88-36.89l10.2,1.57s2.91.31,5.35,3.09,4.43,8.03,7.6,17.31c7.56,22.1,25.12,39.25,25.12,39.25,0,0,5.6,7.43,33.44,12.66,23.08,4.34,42.7-2.46,42.7-2.46,17.72-7.17,21.63-44.96,21.63-44.96,0,0,1.83-13.3,7.81-16.65,7.37-4.14,8.27-4.44,12.71-5.32,3.61-.71.24-13.13,0-16.54Z"
                                ></path>
                            </g>
                            <g id="verres">
                                <path
                                    fill={lunette.couleur_verres || "#7fa1e7"}
                                    opacity="0.65"
                                    d="M116.32,162.87c-.88,6.05.4,37.41,11.44,55.31s37.04,21.35,41.37,21.31,18.51,1.02,24.47-9.27c4.97-8.59,13.17-43.48,9.12-53.05-6.26-14.82-40.4-24.02-40.4-24.02,0,0-26.85-5.46-33.82-4.46,0,0-9.97-.96-12.17,14.17Z"
                                ></path>
                                <path
                                    fill={lunette.couleur_verres || "#7fa1e7"}
                                    opacity="0.65"
                                    d="M247.32,192.54s-1.09-9.55,19.57-16.69c11.76-4.06,60.46,3.23,60.46,3.23,0,0,19.09,4.06,21.71,8.28,2.62,4.22,9.46,17.24,8.29,37.97-1.14,20.21-7.31,26.8-12.61,30.31,0,0-7.1,4.93-21.34,5.93-26.65,1.88-37.01-1.14-46.19-7.73-29.88-21.46-29.88-61.3-29.88-61.3Z"
                                ></path>
                            </g>
                        </g>
                    </svg>
                </div>
            </div>

            <!-- Informations détaillées -->
            <div class="lunette-info-panel">
                <h1 class="lunette-title">{lunette.nom_modele}</h1>

                {
                    isOwner && (
                        <div class="owner-badge">
                            <svg
                                width="16"
                                height="16"
                                viewBox="0 0 16 16"
                                fill="currentColor"
                            >
                                <path d="M8 0L10.5 5.5L16 6.5L12 10.5L13 16L8 13.5L3 16L4 10.5L0 6.5L5.5 5.5L8 0Z" />
                            </svg>
                            Ma création
                        </div>
                    )
                }

                <div class="info-section">
                    <h2 class="section-title">Caractéristiques</h2>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">Taille :</span>
                            <span class="info-value"
                                >{lunette.taille_monture}</span
                            >
                        </div>

                        {
                            lunette.expand?.materiaux_lunettes && (
                                <div class="info-item">
                                    <span class="info-label">
                                        Matériau monture :
                                    </span>
                                    <span class="info-value">
                                        {
                                            lunette.expand.materiaux_lunettes
                                                .nom_materiaux
                                        }
                                    </span>
                                    <span class="info-price">
                                        {
                                            lunette.expand.materiaux_lunettes
                                                .prix_materiaux
                                        }
                                        €
                                    </span>
                                </div>
                            )
                        }

                        {
                            lunette.expand?.id_verres && (
                                <div class="info-item">
                                    <span class="info-label">
                                        Type de verres :
                                    </span>
                                    <span class="info-value">
                                        {lunette.expand.id_verres.nom_verres}
                                    </span>
                                    <span class="info-price">
                                        {lunette.expand.id_verres.prix_verres}€
                                    </span>
                                </div>
                            )
                        }
                    </div>
                </div>

                <div class="info-section">
                    <h2 class="section-title">Couleurs</h2>
                    <div class="colors-list">
                        <div class="color-item">
                            <span class="color-label">Monture</span>
                            <div class="color-display">
                                <span
                                    class="color-swatch-large"
                                    style={`background: ${lunette.couleur_monture}`}
                                ></span>
                                <span class="color-code"
                                    >{lunette.couleur_monture}</span
                                >
                            </div>
                        </div>

                        <div class="color-item">
                            <span class="color-label">Branches</span>
                            <div class="color-display">
                                <span
                                    class="color-swatch-large"
                                    style={`background: ${lunette.couleur_branche}`}
                                ></span>
                                <span class="color-code"
                                    >{lunette.couleur_branche}</span
                                >
                            </div>
                        </div>

                        {
                            lunette.couleur_verres && (
                                <div class="color-item">
                                    <span class="color-label">Verres</span>
                                    <div class="color-display">
                                        <span
                                            class="color-swatch-large"
                                            style={`background: ${lunette.couleur_verres}`}
                                        />
                                        <span class="color-code">
                                            {lunette.couleur_verres}
                                        </span>
                                    </div>
                                </div>
                            )
                        }
                    </div>
                </div>

                {
                    lunette.expand?.materiaux_lunettes &&
                        lunette.expand?.id_verres && (
                            <div class="price-total">
                                <span class="price-label">Prix total :</span>
                                <span class="price-value">
                                    {(
                                        lunette.expand.materiaux_lunettes
                                            .prix_materiaux +
                                        lunette.expand.id_verres.prix_verres
                                    ).toFixed(2)}
                                    €
                                </span>
                            </div>
                        )
                }

                {
                    isOwner && (
                        <div class="action-buttons">
                            <a href="/" class="btn-primary">
                                Commandez
                            </a>
                        </div>
                    )
                }
            </div>
        </div>
    </main>

    <style>
        .lunette-detail-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .back-link {
            margin-bottom: 2rem;
        }

        .back-link a {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: #666;
            text-decoration: none;
            font-size: 0.95rem;
            transition: color 0.3s ease;
        }

        .back-link a:hover {
            color: #4a6bff;
        }

        .lunette-detail-grid {
            display: grid;
            grid-template-columns: 1.2fr 1fr;
            gap: 3rem;
            align-items: start;
        }

        .lunette-preview-large {
            position: sticky;
            top: 2rem;
        }

        .preview-card {
            background: linear-gradient(135deg, #f0f1f5 0%, #e8e9ef 100%);
            border-radius: 16px;
            padding: 4rem 3rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .preview-card svg {
            max-width: 100%;
            height: auto;
        }

        .lunette-info-panel {
            background: white;
            border-radius: 16px;
            padding: 2.5rem;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        }

        .lunette-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: #222;
            margin-bottom: 1rem;
        }

        .owner-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, #4a6bff 0%, #3a5bef 100%);
            color: white;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 2rem;
        }

        .info-section {
            margin-top: 2.5rem;
            padding-top: 2rem;
            border-top: 1px solid #f0f0f0;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #444;
            margin-bottom: 1.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .info-grid {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .info-label {
            font-weight: 600;
            color: #666;
            min-width: 140px;
        }

        .info-value {
            color: #222;
            font-weight: 500;
            flex: 1;
        }

        .info-price {
            color: #4a6bff;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .colors-list {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        .color-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .color-label {
            font-weight: 600;
            color: #666;
            min-width: 100px;
        }

        .color-display {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .color-swatch-large {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            border: 3px solid #e0e0e0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .color-code {
            font-family: "Monaco", "Courier New", monospace;
            font-size: 0.9rem;
            color: #666;
            text-transform: uppercase;
        }

        .price-total {
            margin-top: 2.5rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, #f0f7ff 0%, #e6f0fd 100%);
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .price-label {
            font-size: 1.1rem;
            font-weight: 600;
            color: #444;
        }

        .price-value {
            font-size: 2rem;
            font-weight: 800;
            color: #4a6bff;
        }

        .action-buttons {
            margin-top: 2rem;
            display: flex;
            gap: 1rem;
        }

        .btn-primary {
            flex: 1;
            padding: 1rem 2rem;
            background: linear-gradient(135deg, #4a6bff 0%, #3a5bef 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            text-align: center;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(74, 107, 255, 0.3);
        }

        @media (max-width: 1024px) {
            .lunette-detail-grid {
                grid-template-columns: 1fr;
                gap: 2rem;
            }

            .lunette-preview-large {
                position: relative;
                top: 0;
            }

            .preview-card {
                padding: 3rem 2rem;
            }

            .lunette-title {
                font-size: 2rem;
            }
        }

        @media (max-width: 640px) {
            .lunette-detail-container {
                padding: 1rem;
            }

            .lunette-info-panel {
                padding: 1.5rem;
            }

            .info-item,
            .color-item {
                flex-direction: column;
                align-items: flex-start;
            }

            .info-label,
            .color-label {
                min-width: auto;
                margin-bottom: 0.5rem;
            }
        }
    </style>
</Layout>
