---
import Layout from "../../layouts/Layout.astro";
import pb from "../../lib/pb.js";
import PocketBase from "pocketbase";

// Vérifier si l'utilisateur est connecté
let isAuthenticated = false;
let userId = null;
const authCookie = Astro.cookies.get("pb_auth");

if (authCookie && authCookie.value) {
    try {
        const pbAuth = new PocketBase(
            import.meta.env.PUBLIC_POCKETBASE_URL || "http://127.0.0.1:8090",
        );
        pbAuth.authStore.loadFromCookie(authCookie.value);
        isAuthenticated = pbAuth.authStore.isValid && !!pbAuth.authStore.model;
        userId = pbAuth.authStore.model?.id;
        console.log(
            "Auth check collection - Connecté:",
            isAuthenticated,
            "User:",
            pbAuth.authStore.model?.email,
        );
    } catch (e) {
        console.error("Erreur vérification auth:", e);
        isAuthenticated = false;
    }
}

// Rediriger vers login si non connecté
if (!isAuthenticated) {
    console.log("❌ Non connecté - redirection vers /login");
    return Astro.redirect("/login");
}

console.log("✅ Connecté - accès autorisé à la collection");

// Charger les lunettes de l'utilisateur connecté
let mesLunettes = [];
try {
    // Récupérer les IDs des lunettes créées par l'utilisateur
    const relations = await pb.collection("creer").getFullList({
        filter: `id_utilisateur = "${userId}"`,
        expand: "id_lunettes,id_lunettes.materiaux_lunettes,id_lunettes.id_verres",
    });

    mesLunettes = relations
        .map((rel) => rel.expand?.id_lunettes)
        .filter(Boolean);
    console.log("Lunettes trouvées:", mesLunettes.length);
} catch (e) {
    console.error("Erreur chargement lunettes:", e);
}
---

<Layout title="Ma Collection">
    <main class="collection-container">
        <div class="auth-bgword">COLLECTION</div>

        {
            mesLunettes.length === 0 ? (
                <div class="empty-state">
                    <p class="empty-message">
                        Vous n'avez pas encore créé de lunettes.
                    </p>
                    <a href="/personnalisation" class="cta-button">
                        Créer ma première paire →
                    </a>
                </div>
            ) : (
                <div class="lunettes-grid">
                    {mesLunettes.map((lunette) => (
                        <div class="lunette-card-wrapper">
                            <a
                                href={`/collection/${lunette.id}`}
                                class="lunette-card"
                            >
                                <div
                                    class="lunette-preview"
                                    style={`background: linear-gradient(135deg, ${lunette.couleur_monture}15 0%, ${lunette.couleur_branche}15 100%)`}
                                >
                                    <svg
                                        viewBox="0 0 595.28 350"
                                        width="200"
                                        height="80"
                                    >
                                        <g>
                                            <g id="branches">
                                                <path
                                                    fill={
                                                        lunette.couleur_branche
                                                    }
                                                    d="M108.83,155.14s49.35-5.57,54.93-8.76,11.14-7.96,19.5-9.55,64.48-11.14,64.48-11.14c0,0,7.16-1.99,17.51,5.57s33.04,31.84,39.4,31.05c6.37-.8,9.55-9.55,7.56-13.53s-40.67-32.75-47.36-34.63c-9.53-2.68-21.89-2.39-37.02,0-15.12,2.39-116.22,23.34-116.22,23.34,0,0-13.13,6.12-2.79,17.66Z"
                                                />
                                                <path
                                                    fill={
                                                        lunette.couleur_branche
                                                    }
                                                    d="M308.24,150.76s-.31,6.15-3.98,5.57c-4.97-.78-35.82-33.83-46.17-32.24,0,0,8.53,2.71,18.46,11.64,6.51,5.86,34.42,37.85,31.69,15.03Z"
                                                />
                                                <path
                                                    fill={
                                                        lunette.couleur_branche
                                                    }
                                                    d="M374.79,179.65l90.54-29.78s22.13-5.63,25.35-4.02,17.71,30.58,17.71,33.8-2.42,14.01-5.63,14.89c-2.33.64-5.33.11-6.84-4.21-1.41-4.02-6.84-31.73-12.47-31.47s-50.7,15.95-50.7,15.95c0,0-13.28,6.44-18.91,11.27s-32.19,11.27-32.19,11.27c0,0-9.66-7.65-6.84-17.71Z"
                                                />
                                                <path
                                                    fill={
                                                        lunette.couleur_branche
                                                    }
                                                    d="M381.34,180.1s102.27-35.19,107.85-31.99c0,0-18.2,2.49-41.76,11.88s-66.09,22.03-66.09,22.03v-1.92Z"
                                                />
                                                <path
                                                    fill={
                                                        lunette.couleur_branche
                                                    }
                                                    d="M485.36,158.06s3.26,0,4.98,3.45,9.77,24.71,9.77,24.71c0,0,.77,4.98,5.17-2.68,0,0-3.07,9.56-5.36,6.79s-9.77-26.33-9.77-26.33c0,0-2.87-6.74-4.79-5.94Z"
                                                />
                                            </g>
                                            <g id="monture">
                                                <path
                                                    fill={
                                                        lunette.couleur_monture
                                                    }
                                                    d="M385.31,180.81c-.24-3.41-9.57-5.22-12.71-6.4-3.14-1.18-15.7,1.96-15.7,1.96-12.17-3.14-54.55-9.03-78.88-9.03s-32.57,11.38-35.32,10.99c-2.75-.39-17.27-.78-23.55-1.96-6.28-1.18-5.1-14.13-39.25-26.48-34.14-12.35-68.29-12.42-68.29-12.42-13.35,4.66-6.76,18.49-6.76,18.49l2.05,6.35c4.32,2.03,3.14,10.52,4.71,23.08s7.46,28.65,14.13,38.46c6.67,9.81,31.79,20.8,44.35,21.19s23.55-1.96,31.79-15.31c8.24-13.34,16.88-36.89,16.88-36.89l10.2,1.57s2.91.31,5.35,3.09,4.43,8.03,7.6,17.31c7.56,22.1,25.12,39.25,25.12,39.25,0,0,5.6,7.43,33.44,12.66,23.08,4.34,42.7-2.46,42.7-2.46,17.72-7.17,21.63-44.96,21.63-44.96,0,0,1.83-13.3,7.81-16.65,7.37-4.14,8.27-4.44,12.71-5.32,3.61-.71.24-13.13,0-16.54Z"
                                                />
                                            </g>
                                            <g id="verres">
                                                <path
                                                    fill={
                                                        lunette.couleur_verres ||
                                                        "#7fa1e7"
                                                    }
                                                    opacity="0.65"
                                                    d="M116.32,162.87c-.88,6.05.4,37.41,11.44,55.31s37.04,21.35,41.37,21.31,18.51,1.02,24.47-9.27c4.97-8.59,13.17-43.48,9.12-53.05-6.26-14.82-40.4-24.02-40.4-24.02,0,0-26.85-5.46-33.82-4.46,0,0-9.97-.96-12.17,14.17Z"
                                                />
                                                <path
                                                    fill={
                                                        lunette.couleur_verres ||
                                                        "#7fa1e7"
                                                    }
                                                    opacity="0.65"
                                                    d="M247.32,192.54s-1.09-9.55,19.57-16.69c11.76-4.06,60.46,3.23,60.46,3.23,0,0,19.09,4.06,21.71,8.28,2.62,4.22,9.46,17.24,8.29,37.97-1.14,20.21-7.31,26.8-12.61,30.31,0,0-7.1,4.93-21.34,5.93-26.65,1.88-37.01-1.14-46.19-7.73-29.88-21.46-29.88-61.3-29.88-61.3Z"
                                                />
                                            </g>
                                        </g>
                                    </svg>
                                </div>
                                <div class="lunette-info">
                                    <h3 class="lunette-name">
                                        {lunette.nom_modele}
                                    </h3>
                                    <div class="lunette-details">
                                        <span class="detail-badge">
                                            Taille: {lunette.taille_monture}
                                        </span>
                                        {lunette.expand?.materiaux_lunettes && (
                                            <span class="detail-badge">
                                                {
                                                    lunette.expand
                                                        .materiaux_lunettes
                                                        .nom_materiaux
                                                }
                                            </span>
                                        )}
                                        {lunette.expand?.id_verres && (
                                            <span class="detail-badge">
                                                {
                                                    lunette.expand.id_verres
                                                        .nom_verres
                                                }
                                            </span>
                                        )}
                                    </div>
                                    <div class="color-swatches">
                                        <span
                                            class="color-swatch"
                                            style={`background: ${lunette.couleur_monture}`}
                                            title="Monture"
                                        />
                                        <span
                                            class="color-swatch"
                                            style={`background: ${lunette.couleur_branche}`}
                                            title="Branches"
                                        />
                                        {lunette.couleur_verres && (
                                            <span
                                                class="color-swatch"
                                                style={`background: ${lunette.couleur_verres}`}
                                                title="Verres"
                                            />
                                        )}
                                    </div>
                                    <div class="lunette-prix">
                                        {(lunette.total || 0).toFixed(2)} €
                                    </div>
                                </div>
                            </a>
                            <button
                                class="add-to-cart-btn"
                                data-lunette-id={lunette.id}
                                data-lunette-nom={lunette.nom_modele}
                                data-lunette-prix={lunette.total || 0}
                            >
                                <svg
                                    width="18"
                                    height="18"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                >
                                    <circle cx="9" cy="21" r="1" />
                                    <circle cx="20" cy="21" r="1" />
                                    <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6" />
                                </svg>
                                Ajouter au panier
                            </button>
                        </div>
                    ))}
                </div>
            )
        }
    </main>

    <style>
        .collection-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 3rem 2rem;
        }

        .auth-bgword {
            font-size: 6rem;
            font-weight: 900;
            color: #c9dbfd;
            opacity: 0.55;
            letter-spacing: 0.04em;
            margin: 2rem 0 2.6rem 0;
            text-align: center;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
        }

        .empty-message {
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 2rem;
        }

        .cta-button {
            display: inline-block;
            padding: 1rem 2rem;
            font-size: 1rem;
            font-weight: 600;
            color: white;
            background: #4a6bff;
            border-radius: 8px;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .cta-button:hover {
            background: #3a5bef;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(74, 107, 255, 0.3);
        }

        .lunettes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 2rem;
        }

        .lunette-card-wrapper {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .lunette-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            text-decoration: none;
            color: inherit;
            display: block;
            cursor: pointer;
        }

        .lunette-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }

        .lunette-preview {
            padding: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 180px;
            border-radius: 12px 12px 0 0;
        }

        .lunette-preview svg {
            max-width: 100%;
            height: auto;
        }

        .lunette-info {
            padding: 1.5rem;
        }

        .lunette-name {
            font-size: 1.3rem;
            font-weight: 700;
            color: #222;
            margin-bottom: 1rem;
        }

        .lunette-details {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .detail-badge {
            display: inline-block;
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
            font-weight: 500;
            color: #666;
            background: #f5f5f5;
            border-radius: 6px;
        }

        .color-swatches {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .color-swatch {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: 2px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .color-swatch:hover {
            transform: scale(1.15);
            border-color: #4a6bff;
        }

        .lunette-prix {
            font-size: 1.5rem;
            font-weight: 700;
            color: #4a6bff;
            margin-top: auto;
        }

        .add-to-cart-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #4a6bff 0%, #3a5bef 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .add-to-cart-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(74, 107, 255, 0.3);
        }

        .add-to-cart-btn svg {
            flex-shrink: 0;
        }

        @media (max-width: 768px) {
            .auth-bgword {
                font-size: 3rem;
                margin: 1rem 0 1.5rem 0;
            }

            .lunettes-grid {
                grid-template-columns: 1fr;
            }

            .collection-container {
                padding: 2rem 1rem;
            }
        }
    </style>

    <script>
        // Gérer l'ajout au panier
        document.querySelectorAll(".add-to-cart-btn").forEach((btn) => {
            btn.addEventListener("click", async (e) => {
                e.preventDefault();
                e.stopPropagation();

                const lunetteId = btn.dataset.lunetteId;
                const lunetteNom = btn.dataset.lunetteNom;
                const lunettePrix = parseFloat(btn.dataset.lunettePrix);

                // Désactiver le bouton pendant l'ajout
                btn.disabled = true;
                btn.textContent = "Ajout...";

                try {
                    // Ajouter au panier via l'API
                    const response = await fetch("/apis/panier", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            id_lunette: lunetteId,
                            nom: lunetteNom,
                            prix: lunettePrix,
                        }),
                    });

                    const result = await response.json();

                    if (result.success) {
                        // Notification de succès
                        showNotification("✓ Ajouté au panier !");

                        // Dispatcher un événement pour mettre à jour le badge
                        window.dispatchEvent(new Event("panier-updated"));
                    } else {
                        alert(
                            result.error || "Erreur lors de l'ajout au panier",
                        );
                    }
                } catch (error) {
                    console.error("Erreur:", error);
                    alert("Erreur lors de l'ajout au panier");
                } finally {
                    // Réactiver le bouton
                    btn.disabled = false;
                    btn.innerHTML = `
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="9" cy="21" r="1"></circle>
                            <circle cx="20" cy="21" r="1"></circle>
                            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                        </svg>
                        Ajouter au panier
                    `;
                }
            });
        });

        // Fonction de notification
        function showNotification(message) {
            const notif = document.createElement("div");
            notif.className = "cart-notification";
            notif.textContent = message;
            document.body.appendChild(notif);

            setTimeout(() => notif.classList.add("show"), 10);
            setTimeout(() => {
                notif.classList.remove("show");
                setTimeout(() => notif.remove(), 300);
            }, 2000);
        }

        // Styles pour la notification
        const style = document.createElement("style");
        style.textContent = `
            .cart-notification {
                position: fixed;
                bottom: 2rem;
                right: 2rem;
                background: #10b981;
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 10px;
                box-shadow: 0 10px 40px rgba(16, 185, 129, 0.3);
                font-weight: 600;
                z-index: 10000;
                opacity: 0;
                transform: translateY(20px);
                transition: all 0.3s ease;
            }
            .cart-notification.show {
                opacity: 1;
                transform: translateY(0);
            }
        `;
        document.head.appendChild(style);
    </script>
</Layout>
